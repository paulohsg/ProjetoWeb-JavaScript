<!DOCTYPE html>
<html>

	<head>
		<link rel="stylesheet" href="style.css">
		<script src="script.js"></script>

		<script src="script.js"></script>

		<script language="JavaScript" type="text/javascript" src="ext/jsbn.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/jsbn2.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/rsa.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/rsa2.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/rsa2-min.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/base64.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/keyutil-1.0.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/keyutil-1.0.min.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/pkcs5pkey-1.0.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/ecdsa-modified-1.0.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/x509-1.1.js"></script>

		<script src="http://yui.yahooapis.com/2.9.0/build/yahoo/yahoo-min.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/core.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/md5.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/sha1.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/sha256.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/ripemd160.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/x64-core.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/sha512.js"></script>

		<script language="JavaScript" type="text/javascript" src="ext2/rsapem-1.1.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/rsasign-1.2.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/asn1hex-1.1.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/x509-1.1.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/crypto-1.1.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/keyutil-1.0.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/keyutil-1.0.min.js"></script>

		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/core.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/cipher-core.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/md5.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/tripledes.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64.js"></script>
		<!-- for crypto -->
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/sha1.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/sha256.js"></script>
		<!-- for crypto, asn1, asn1x509 -->
		<script src="http://yui.yahooapis.com/2.9.0/build/yahoo/yahoo-min.js"></script>
		<!-- for asn1x509(stohex) -->
		<script src="http://kjur.github.io/jsjws/base64x-1.1.min.js"></script>

		<script language="JavaScript" type="text/javascript" src="ext/jsbn.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/jsbn2.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/prng4.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/rng.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/rsa.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/rsa2.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/base64.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/asn1hex-1.1.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/rsapem-1.1.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/rsasign-1.2.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/x509-1.1.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/pkcs5pkey-1.0.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/asn1-1.0.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/asn1x509-1.0.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/crypto-1.1.js"></script>

		<script language="JavaScript" type="text/javascript" src="ext/ec.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext/ec-patch.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/ecdsa-modified-1.0.js"></script>
		<script language="JavaScript" type="text/javascript" src="ext2/ecparam-1.0.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

	</head>

	<script >
		var _pubKey = null;
		//chave pública ECDSA
		var _pubKeyVer = null;
		var _prvKey = null;
		//chave privada ECD
		var _algAss = null;
		//algoritmo utilizado para realizar a assinatura
		//var _alg = "RSA";
		var _lencurve = 1024;
		//valor da curva
		var _curva = null;
		var _strHex = null;
		//string hexadecimal do arquivo
		//var _assinatura = null;  //assinatura, gerada através do arquivo em hexadecimal e a chave privada.

		function geraParChaves() {
			var ec = KJUR.crypto.ECDSA({
				'curve' : 'secp256r1'
			});
			var ec = new KJUR.crypto.ECDSA({
				"curve" : ec
			});
			var keypair = ec.generateKeyPairHex();

			_pubKey = keypair.ecpubhex;
			_prvKey = keypair.ecprvhex;
			_algAss = document.getElementById("algAss").value;
			_curva = document.getElementById("valorCurva").value;

			document.getElementById("pubKey").value = _pubKey;

		}

		function assina() {

			var sig = new KJUR.crypto.Signature({
				"alg" : _algAss,
				"prov" : "cryptojs/jsrsa"
			});
			sig.initSign({
				'ecprvhex' : _prvKey,
				'eccurvename' : _curva
			});

			sig.updateHex(_strHex);
			var assinatura = sig.sign();

			//return sigValueHex;
			document.getElementById("arqAss").value = assinatura;

		}

		function verificaAssinatura() {

			var assinatura = document.getElementById("arqAssVer").value;
			var pubKey = document.getElementById("pubKeyVer").value;

			var sig = new KJUR.crypto.Signature({
				"alg" : _algAss,
				"prov" : "cryptojs/jsrsa"
			});
			sig.initVerifyByPublicKey({
				'ecpubhex' : pubKey,
				'eccurvename' : _curva
			});
			sig.updateHex(_strHex);
			var result = sig.verify(assinatura);

			if (result) {
				alert("Assinatura Válida!");
			} else {
				alert("Assinatura Inválida");
			}
		}

		

		
		

		//transforma um arquivo em uma string hexadecimal
		function file2hex(file) {
			// Only read the start of the file
			var reader = new FileReader();
			// Create an asynchronous FileReader
			reader.readAsArrayBuffer(file);
			// Read the slice of the file
			reader.onload = function(e) {
				var buffer = reader.result;
				// The result ArrayBuffer
				var view = new DataView(buffer);
				// Get access to the result bytes
				var magic = view.getUint8(0, false);
				// Read 4 bytes, big-endian
				var numint = new Int8Array(buffer);

				var tam = numint.length;
				var saida = "";

				for (var i = 0; i < tam; i++) {
					saida += numint[i].toString(16);
				}

				_strHex = saida;

				
			};
		}

		

		function copiaAss() {

			var assinatura = document.getElementById("arqAss").value;
			document.getElementById("arqAssVer").value = assinatura;

		}

		function copiaPK() {
			document.getElementById("pubKeyVer").value = _pubKey;
		}

		//DIV ASSINA
		$(document).ready(function() {
			$("#botaoAssinaIni").click(function() {
				$("#botaoGeraChaves").fadeIn("slow");
				$("#txtCurvaAlg").fadeIn("slow");
				$("#valorCurva").fadeIn("slow");
				$("#algAss").fadeIn("slow");

			});
		});

		$(document).ready(function() {
			$("#botaoGeraChaves").click(function() {
				$("#txtGenKey").fadeIn(1000);
				$("#pubKey").fadeIn(5000);
				$("#selArq").fadeIn(5000);
				$("#botaoAssina").fadeIn(5000);
				$("#txtPubKey").fadeIn(5000);
				$("#txtSelArq").fadeIn(5000);

			});
		});

		$(document).ready(function() {
			$("#botaoAssina").click(function() {
				$("#txtAssinatura").fadeIn("slow");
				$("#arqAss").fadeIn("slow");

			});
		});

		//DIV VERIFICA

		$(document).ready(function() {
			$("#botaoVerificaIni").click(function() {
				$("#txtInsiraPK").fadeIn("slow");
				$("#pubKeyVer").fadeIn("slow");
				$("#botaoCopiaPK").fadeIn("slow");
				$("#txtSelArqVer").fadeIn("slow");
				$("#selArqVer").fadeIn("slow");
				$("#txtArqAssVer").fadeIn("slow");
				$("#botaoCopiaAss").fadeIn("slow");
				$("#arqAssVer").fadeIn("slow");
				$("#botaoVerifica").fadeIn("slow");

			});
		});

	</script>

	<body>

		<h1 id="titulo">
		<center>
			Assinatura Digital ECDSA
		</center></h1>

		<div id="pai">

			<a class="but" id="botaoAssinaIni" >Assinar arquivo</a>
			<a class="but" id="botaoVerificaIni" >Verificar assinatura</a>

			<div id="divAssina">

				<a class="but" id="botaoGeraChaves" onclick="geraParChaves()">Gerar par de chaves</a>

				<p id="txtCurvaAlg">
					Selecione o valor da curva e o algoritmo que será usado para gerar as chaves
				</p>
				<p id="txtGenKey">
					Par de chaves gerado!
				</p>

				<select id="valorCurva" name="curva">
					<option value="secp256r1">secp256r1 (= NIST P-256, P-256, prime256v1) <option value="secp256k1">secp256k1 <option value="secp384r1">secp384r1 (= NIST P-384, P-384)
				</select>

				<select id="algAss" name="algoritmoAssinatura">
					<option value="SHA256withECDSA">SHA256withECDSA <option value="SHA1withECDSA">SHA1withECDSA
				</select>

				<p id="txtSelArq">
					Agora selecione o arquivo que será assinado
				</p>

				<input id="selArq" type="file" onchange="file2hex(this.files[0])"/>

				<p id="txtPubKey">
					Chave pública:
				</p>
				<textarea id="pubKey" name="publicKey" rows="1" cols="70">
      	
      </textarea>				
      
      
      
      
      

				<button class="but" id="botaoAssina" onclick="assina()" type="button" >
					Assinar
				</button>

				<p id="txtAssinatura">
					Assinatura:
				</p>
				<textarea id="arqAss" name="publicKey" rows="4" cols="70">
	  	
	  </textarea>
				
	
	
	
 <!--      DIV VERIFICA-->
			</div>

			<div id="divVerifica">

				<p id="txtInsiraPK">
					Insira a chave pública:
				</p>
				<textarea id="pubKeyVer" name="chavePublicaVerificacao" rows="4" cols="70">
	  </textarea>
				
	  
 <a class="but" id="botaoCopiaPK" onclick="copiaPK()">Copiar CPub --></a>

				<p id="txtSelArqVer">
					Selecione o arquivo para o qual foi gerada a assinatura:
				</p>

				<input id="selArqVer" type="file" onchange="file2hex(this.files[0])"/>

				<p id="txtArqAssVer">
					Insira a assinatura que foi gerada para esse arquivo
				</p>

				<a class="but" id="botaoCopiaAss" onclick="copiaAss()">Copiar assinatura --></a>
				<textarea id="arqAssVer" name="publicKeyVerifica" rows="1" cols="70">
	  	
	  </textarea>
				
	

 <!--<button id="botaoVerifica" onclick="verifica()" type="button" >assina</button>-->

				<a class="but" id="botaoVerifica" onclick="verificaAssinatura()">Verificar</a>

			</div>

		</div>

	</body>

</html>
